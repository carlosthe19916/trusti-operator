# Local development

## Minikube

Start minikube

```shell
minikube start --cpus=8 --memory=10g
minikube addons enable ingress
```

## Setup CDRs

```shell
mvn clean package -DskipTests
kubectl apply -f target/kubernetes/trustis.org.trusti-v1.yml
```

## Start server in dev mode

```shell
mvn compile quarkus:dev
```

## Instantiate Operator

```shell
kubectl apply -f scripts/trusti.yaml
```

At this point the container images will be generated by the operator.

# Test Operator in OCP

Create operator container:

```shell
mvn clean package -DskipTests \
-Dquarkus.native.container-build=true \
-Dquarkus.container-image.build=true \
-Dquarkus.container-image.push=false \
-Dquarkus.container-image.registry=quay.io \
-Dquarkus.container-image.group=$USER \
-Dquarkus.container-image.name=trusti-operator \
-Dquarkus.operator-sdk.bundle.package-name=trusti-operator \
-Dquarkus.operator-sdk.bundle.channels=alpha \
-Dquarkus.application.version=0.0.0
docker push quay.io/$USER/trusti-operator:0.0.0
```

Enrich bundle with cluster permissions (util only if generating a catalog for OCP)

```shell
groovy scripts/enrichCSV.groovy target/bundle/trusti-operator/manifests/trusti-operator.clusterserviceversion.yaml
```

Create bundle:

```shell
BUNDLE_IMAGE=quay.io/$USER/trusti-operator-bundle:0.0.0
docker build -t $BUNDLE_IMAGE -f target/bundle/trusti-operator/bundle.Dockerfile target/bundle/trusti-operator
docker push $BUNDLE_IMAGE
```

Create catalog image:

```shell
CATALOG_IMAGE=quay.io/$USER/trusti-operator-catalog:0.0.0
opm index add \
  --bundles $BUNDLE_IMAGE \
  --tag $CATALOG_IMAGE \
  --build-tool docker
docker push $CATALOG_IMAGE
```

Create catalog:

```shell
cat <<EOF | kubectl apply -f -
apiVersion: operators.coreos.com/v1alpha1
kind: CatalogSource
metadata:
  name: trusti-catalog-source
  namespace: openshift-marketplace
spec:
  sourceType: grpc
  image: $CATALOG_IMAGE
EOF
```

At this point you can see the Operator in the marketplace of OCP ready for you to test it.
